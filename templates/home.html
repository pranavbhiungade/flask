<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Grouped SOPs - Home</title>
  <link href="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.css" rel="stylesheet" />
  <style>
    body { font-family: Arial, sans-serif; background: #121212; margin: 0; padding: 0; color: #e0e0e0; }
    .container { max-width: 1200px; margin: 40px auto; background: #1e1e1e; border-radius: 8px; box-shadow: 0 2px 12px rgba(0,0,0,0.6); padding: 32px; }
    h1 { color: #00bcd4; text-align: center; margin-bottom: 24px; }
    h3 { margin: 24px 0 12px 0; color: #ffffff; font-weight: bold; text-align: left; border-left: 4px solid #00bcd4; padding-left: 10px; }
    table { border-collapse: collapse; width: 100%; margin-bottom: 24px; border: 1px solid #333; background: #1a1a1a; }
    th, td { border: 1px solid #333; padding: 10px 12px; text-align: left; font-size: 14px; color: #e0e0e0; }
    th { background: #2c2c2c; font-weight: 600; color: #00bcd4; }
    tr:nth-child(even) { background: #2a2a2a; }
    tr:nth-child(odd) { background: #1e1e1e; }
    tr:hover { background: #333; }
    a { color: #03a9f4; text-decoration: none; }
    a:hover { text-decoration: underline; color: #29b6f6; }
    .loading, .no-data { text-align: center; padding: 20px; font-style: italic; color: #aaa; }
    .action-btn { padding: 6px 10px; margin: 0 4px; border: none; border-radius: 4px; cursor: pointer; font-size: 12px; }
    .edit-btn { background: #2196f3; color: white; }
    .edit-btn:hover { background: #42a5f5; }
    .delete-btn { background: #f44336; color: white; }
    .delete-btn:hover { background: #ef5350; }
    .open-sop-btn { background: #0ea5e9; color: #fff; border-radius: 6px; padding: 6px 10px; font-size: 13px; border: none; cursor: pointer; }
    .open-sop-btn:hover { opacity: 0.95; }
    /* Modal override to use dark theme */
    .modal-bg { background: #121212; color: #e0e0e0; }
    .modal-card { background: #1f1f1f; color: #e0e0e0; border-radius: 8px; padding: 16px; }
  </style>
</head>
<body>
  <div id="toast-container" class="fixed top-5 right-5 z-50 space-y-2"></div>

  <div class="container">
    <h1 style="font-size: 48px;" >ActionMap</h1>
     <form class="max-w-md mx-auto my-6">
      <label for="default-search" class="mb-2 text-sm font-medium text-gray-900 sr-only dark:text-white">Search</label>
      <div class="relative">
        <div class="absolute inset-y-0 start-0 flex items-center ps-3 pointer-events-none">
          <svg class="w-4 h-4 text-gray-500 dark:text-gray-400" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m19 19-4-4m0-7A7 7 0 1 1 1 8a7 7 0 0 1 14 0Z"/>
          </svg>
        </div>
        <input type="search" id="default-search" class="block w-full p-4 ps-10 text-sm text-gray-900 border border-gray-300 rounded-lg bg-gray-50 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-700 dark:border-gray-600 dark:placeholder-gray-400 dark:text-white dark:focus:ring-blue-500 dark:focus:border-blue-500" placeholder="Enter Alert Name" required />
        <button type="submit" class="text-white absolute end-2.5 bottom-2.5 bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-4 py-2 dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">Search</button>
      </div>
    </form>
    <div id="sops-content" class="loading">Loading...</div>
   
  </div>

  <!-- Delete Confirmation Modal -->
<div id="popup-modal" tabindex="-1"  class="hidden fixed inset-0 z-50 flex justify-center items-center w-full h-full bg-black bg-opacity-50">
  <div class="relative p-4 w-full max-w-md max-h-full">
    <div class="relative bg-white rounded-lg shadow-sm dark:bg-gray-700">
      <button type="button" class="absolute top-3 end-2.5 text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white" data-modal-hide="popup-modal" onclick="hideDeleteModal()">
        <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
          <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
        </svg>
        <span class="sr-only">Close modal</span>
      </button>
      <div class="p-4 md:p-5 text-center">
        <svg class="mx-auto mb-4 text-gray-400 w-12 h-12 dark:text-gray-200" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 20 20">
          <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 11V6m0 8h.01M19 10a9 9 0 1 1-18 0 9 9 0 0 1 18 0Z"/>
        </svg>
        <h3 class="mb-5 text-lg font-normal text-gray-500 dark:text-gray-400">Are you sure you want to delete this SOP?</h3>
        <button id="confirm-delete-btn" type="button" class="text-white bg-red-600 hover:bg-red-800 focus:ring-4 focus:outline-none focus:ring-red-300 dark:focus:ring-red-800 font-medium rounded-lg text-sm inline-flex items-center px-5 py-2.5 text-center">
          Yes, I'm sure
        </button>
        <button type="button" class="py-2.5 px-5 ms-3 text-sm font-medium text-gray-900 focus:outline-none bg-white rounded-lg border border-gray-200 hover:bg-gray-100 hover:text-blue-700 focus:z-10 focus:ring-4 focus:ring-gray-100 dark:focus:ring-gray-700 dark:bg-gray-800 dark:text-gray-400 dark:border-gray-600 dark:hover:text-white dark:hover:bg-gray-700" onclick="hideDeleteModal()">No, cancel</button>
      </div>
    </div>
  </div>
</div>

<script>
  let deleteSOPId = null;

  async function fetchGroupedSOPs() {
    try {
      const response = await fetch("http://192.168.64.1:5000/home");
      if (!response.ok) throw new Error("Network response was not ok");

      const data = await response.json();
      const container = document.getElementById("sops-content");
      container.innerHTML = "";

      if (!data.length) {
        container.innerHTML = '<div class="no-data">⚠️ No SOPs found.</div>';
        return;
      }

      let html = "";

      data.forEach(serviceObj => {
        serviceObj.versions.forEach(versionObj => {
          html += `<h3>${escapeHtml(serviceObj.service)} | ${escapeHtml(versionObj.version)}</h3>`;
          html += `<div style="overflow-x:auto;"><table><thead><tr>
            <th>ID</th>
            <th>Alert_Name</th>
            <th>Title</th>
            <th>Description</th>
            <th>SOP</th>
            <th>Created By</th>
            <th>Last Modified By</th>
            <th>Created At</th>
            <th>Updated At</th>
            <th>Actions</th>
          </tr></thead><tbody>`;

          versionObj.sops.forEach(sop => {
            const sopData = encodeURIComponent(JSON.stringify(sop));
            html += `<tr>
              <td>${sop.id}</td>
              <td>${escapeHtml(sop.alert_name || '-')}</td>
              <td>${escapeHtml(sop.sop_title || '-')}</td>
              <td>${escapeHtml(sop.sop_description || '-')}</td>
              <td>${sop.sop_link ? `<button type="button" class="open-sop-btn" data-sop='${sopData}'>Open</button>` : '-'}</td>
              <td>${escapeHtml(sop.created_by || '-')}</td>
              <td>${escapeHtml(sop.last_modified_by || '-')}</td>
              <td>${escapeHtml(sop.created_at || '-')}</td>
              <td>${escapeHtml(sop.updated_at || '-')}</td>
              <td style="display:flex;gap:8px;align-items:center;justify-content:left;">
                <button class="action-btn edit-btn" title="Edit" onclick='openEditModal(${JSON.stringify(sop)})' style="display:inline-flex;align-items:center;">
                  <!-- edit icon --> 
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24"><path fill="currentColor" d="M4 21h17v2H3a1 1 0 0 1-1-1V3a1 1 0 0 1 1-1h2v2H4v17zm16.7-13.3a1 1 0 0 0 0-1.4l-2-2a1 1 0 0 0-1.4 0l-9.6 9.6a1 1 0 0 0-.3.6l-.7 4.2a1 1 0 0 0 1.2 1.2l4.2-.7a1 1 0 0 0 .6-.3l9.6-9.6zm-3.3-1.3 2 2-1.3 1.3-2-2L17.4 6.4zm-9 9 6.6-6.6 2 2-6.6 6.6-2.5.4.5-2.4z"/></svg>
                </button> 
                <button class="action-btn delete-btn" title="Delete" onclick="deleteSOP(${sop.id})" style="display:inline-flex;align-items:center;">
                  <!-- delete icon -->
                  <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="none" viewBox="0 0 24 24"><path fill="currentColor" d="M5 6h14v2H5V6zm2 3h10l-1.5 12.5a1 1 0 0 1-1 .5h-5a1 1 0 0 1-1-.5L7 9zm3 2v7h2v-7h-2z"/></svg>
                </button>
              </td>
            </tr>`;
          });

          html += `</tbody></table></div>`;
        });
      });

      container.innerHTML = html;

      document.querySelectorAll('.open-sop-btn').forEach(btn => {
        btn.addEventListener('click', () => {
          const encoded = btn.getAttribute('data-sop');
          if (!encoded) return;
          showSOPModal(encoded);
        });
      });

    } catch (error) {
      document.getElementById("sops-content").innerHTML =
        '<div class="no-data">❌ Failed to load SOPs. Please try again.</div>';
      console.error("Error fetching SOPs:", error);
    }
  }

  function editSOP(id) {
    alert("Edit SOP with ID: " + id);
  }

  function deleteSOP(id) {
    deleteSOPId = id;
    document.getElementById('popup-modal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
  }

  function hideDeleteModal() {
    document.getElementById('popup-modal').classList.add('hidden');
    document.body.style.overflow = '';
    deleteSOPId = null;
  }

  document.getElementById('confirm-delete-btn').addEventListener('click', async () => {
  if (deleteSOPId !== null) {
    try {
      const response = await fetch(`http://192.168.64.1:5000/sops/${deleteSOPId}`, {
        method: "DELETE",
        headers: { "Content-Type": "application/json" }
      });

      if (!response.ok) {
        const error = await response.json();
        alert("❌ Failed to delete SOP: " + (error.error || response.statusText));
        return;
      }

      if (!response.ok) {
  const error = await response.json();
  showToast("❌ Failed to delete SOP: " + (error.error || response.statusText), "error");
  return;
}

const result = await response.json();
showToast(result.message, "success");

// Refresh the SOP list after deletion
fetchGroupedSOPs();

    } catch (err) {
      console.error("Delete error:", err);
      alert("❌ Error deleting SOP.");
    } finally {
      hideDeleteModal();
    }
  }
});

  function showSOPModal(encodedSop) {
    try {
      const sop = JSON.parse(decodeURIComponent(encodedSop));
      document.getElementById('sop-modal-title').textContent = 'SOP';
      document.getElementById('sop-modal-body').innerHTML = `
        <div class="mb-2 text-center">
          ${sop.sop_link ? `<a href="${sop.sop_link}" target="_blank" class="text-blue-600 underline text-lg">${escapeHtml(sop.sop_link)}</a>` : '-'}
        </div>
      `;
      document.getElementById('sop-modal').classList.remove('hidden');
      document.body.style.overflow = 'hidden';
    } catch (err) {
      console.error('Failed to parse SOP JSON:', err);
      alert('Unable to open SOP details.');
    }
  }

  function hideSOPModal() {
    document.getElementById('sop-modal').classList.add('hidden');
    document.body.style.overflow = '';
  }

  function openEditModal(sop) {
    document.getElementById('crud-modal').classList.remove('hidden');
    document.body.style.overflow = 'hidden';
    document.getElementById('edit-sop-id').value = sop.id;
    document.getElementById('edit-sop-alert').value = sop.alert_name || '';
    document.getElementById('edit-sop-title').value = sop.sop_title || '';
    document.getElementById('edit-sop-description').value = sop.sop_description || '';
    document.getElementById('edit-sop-link').value = sop.sop_link || '';
    document.getElementById('edit-sop-service').value = sop.service || '';
    document.getElementById('edit-sop-version').value = sop.version || '';
  }
  function hideEditModal() {
    document.getElementById('crud-modal').classList.add('hidden');
    document.body.style.overflow = '';
  }
  function submitEditSOP(event) {
    event.preventDefault();
    hideEditModal();
    alert('SOP updated (implement backend call)');
  }

  function escapeHtml(str) {
    if (str === null || str === undefined) return '';
    return String(str)
      .replace(/&/g, '&amp;')
      .replace(/</g, '&lt;')
      .replace(/>/g, '&gt;')
      .replace(/"/g, '&quot;')
      .replace(/'/g, '&#39;');
  }

  //  Toast Notification
  function showToast(message, type = "success") {
  const container = document.getElementById("toast-container");

  // Different styles for success & error
  const bgColor = type === "success" 
    ? "text-green-500 bg-green-100 dark:bg-green-800 dark:text-green-200" 
    : "text-red-500 bg-red-100 dark:bg-red-800 dark:text-red-200";

  const toast = document.createElement("div");
  toast.className = "flex items-center w-full max-w-xs p-4 mb-4 text-gray-500 bg-white rounded-lg shadow-sm dark:text-gray-400 dark:bg-gray-800";
  toast.role = "alert";
  toast.innerHTML = `
    <div class="inline-flex items-center justify-center shrink-0 w-8 h-8 ${bgColor} rounded-lg">
      <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 20 20">
        <path d="${type === "success"
          ? "M16.707 5.293a1 1 0 0 0-1.414 0L9 11.586 6.707 9.293a1 1 0 1 0-1.414 1.414l3 3a1 1 0 0 0 1.414 0l7-7a1 1 0 0 0 0-1.414Z"
          : "M10 .5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 10 .5Zm3.707 11.793a1 1 0 1 1-1.414 1.414L10 11.414l-2.293 2.293a1 1 0 0 1-1.414-1.414L8.586 10 6.293 7.707a1 1 0 0 1 1.414-1.414L10 8.586l2.293-2.293a1 1 0 0 1 1.414 1.414L11.414 10l2.293 2.293Z"}" />
      </svg>
    </div>
    <div class="ms-3 text-sm font-normal">${message}</div>
    <button type="button" class="ms-auto -mx-1.5 -my-1.5 text-gray-400 hover:text-gray-900 rounded-lg focus:ring-2 focus:ring-gray-300 p-1.5 hover:bg-gray-100 dark:text-gray-500 dark:hover:text-white dark:hover:bg-gray-700 inline-flex items-center justify-center h-8 w-8" onclick="this.parentElement.remove()">
      <span class="sr-only">Close</span>
      <svg class="w-3 h-3" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
      </svg>
    </button>
  `;

  container.appendChild(toast);

  // Auto remove toast after 4s
  setTimeout(() => {
    toast.remove();
  }, 4000);
}


  fetchGroupedSOPs();
</script>

  <!-- SOP Modal -->
  <div id="sop-modal" tabindex="-1" aria-hidden="true" class="hidden fixed inset-0 z-50 flex justify-center items-center w-full h-full bg-black bg-opacity-60">
    <div class="relative p-4 w-full max-w-md max-h-full">
      <div class="modal-card flex flex-col items-center justify-center">
        <div style="display:flex;align-items:center;justify-content:space-between;width:100%;border-bottom:1px solid #333;padding-bottom:8px;margin-bottom:10px;">
          <h3 id="sop-modal-title" style="font-size:18px;margin:0"></h3>
          <button type="button" onclick="hideSOPModal()" style="background:transparent;border:none;color:#ccc;font-size:18px;cursor:pointer;">✕</button>
        </div>
        <div id="sop-modal-body" class="w-full flex flex-col items-center justify-center"></div>
      </div>
    </div>
  </div>

  <!-- Edit SOP Modal -->
<div id="crud-modal" tabindex="-1" aria-hidden="true" class="hidden overflow-y-auto overflow-x-hidden fixed top-0 right-0 left-0 z-50 flex justify-center items-center w-full h-full bg-black bg-opacity-60">
  <div class="relative p-4 w-full max-w-md max-h-full">
    <div class="relative bg-white rounded-lg shadow-sm dark:bg-gray-700">
      <div class="flex items-center justify-between p-4 md:p-5 border-b rounded-t dark:border-gray-600 border-gray-200">
        <h3 class="text-lg font-semibold text-gray-900 dark:text-white">
          Edit SOP
        </h3>
        <button type="button" class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 ms-auto inline-flex justify-center items-center dark:hover:bg-gray-600 dark:hover:text-white" onclick="hideEditModal()">
          <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
            <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
          </svg>
          <span class="sr-only">Close modal</span>
        </button>
      </div>
      <form id="edit-sop-form" class="p-4 md:p-5 space-y-4" onsubmit="submitEditSOP(event)">
        <input type="hidden" id="edit-sop-id" />
        <div>
          <label for="edit-sop-alert" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Alert Name</label>
          <input type="text" id="edit-sop-alert" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white" required>
        </div>
        <div>
          <label for="edit-sop-title" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Title</label>
          <input type="text" id="edit-sop-title" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white" required>
        </div>
        <div>
          <label for="edit-sop-description" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Description</label>
          <textarea id="edit-sop-description" rows="3" class="block p-2.5 w-full text-sm text-gray-900 bg-gray-50 rounded-lg border border-gray-300 focus:ring-blue-500 focus:border-blue-500 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white" required></textarea>
        </div>
        <div>
          <label for="edit-sop-link" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">SOP Link</label>
          <input type="text" id="edit-sop-link" class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-primary-600 focus:border-primary-600 block w-full p-2.5 dark:bg-gray-600 dark:border-gray-500 dark:placeholder-gray-400 dark:text-white">
        </div>
        <button type="submit" class="w-full text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:outline-none focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center dark:bg-blue-600 dark:hover:bg-blue-700 dark:focus:ring-blue-800">
          Update
        </button>
      </form>
    </div>
  </div>
</div>

  <script src="https://cdn.jsdelivr.net/npm/flowbite@3.1.2/dist/flowbite.min.js"></script>
</body>
</html>
